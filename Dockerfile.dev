FROM node:20-slim AS base
RUN corepack enable
WORKDIR /app
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml tsconfig.base.json ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/server/package.json ./packages/server/
COPY packages/client/package.json ./packages/client/

FROM base AS server
RUN apt-get update -y && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*
RUN pnpm install --frozen-lockfile
COPY packages/shared ./packages/shared
COPY packages/server ./packages/server
COPY packages/server/prisma/prisma.config.ts ./packages/server/prisma/
RUN pnpm -F @mp-puzzler/server prisma generate
EXPOSE 3001

FROM base AS client
RUN pnpm install --frozen-lockfile
COPY packages/shared ./packages/shared
COPY packages/client ./packages/client
EXPOSE 5173
