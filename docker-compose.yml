services:
  db:
    image: postgres:16
    container_name: puzzler-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mp_puzzler
    ports:
      - "5432:5432"
    volumes:
      - puzzler-db-data:/var/lib/postgresql/data

  server:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: server
    container_name: puzzler-server
    ports:
      - "3001:3001"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/mp_puzzler
      JWT_SECRET: dev-secret-key
      PORT: 3001
      CLIENT_URL: http://localhost:5173
    depends_on:
      - db
    volumes:
      - ./packages/server:/app/packages/server
      - ./packages/shared:/app/packages/shared
    command: sh -c "cd /app/packages/server && npx prisma generate && cd /app && pnpm -F @mp-puzzler/server dev"

  client:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: client
    container_name: puzzler-client
    ports:
      - "5173:5173"
    environment:
      VITE_BACKEND_URL: http://server:3001
    depends_on:
      - server
    volumes:
      - ./packages/client:/app/packages/client
      - ./packages/shared:/app/packages/shared
    command: pnpm -F @mp-puzzler/client dev --host

volumes:
  puzzler-db-data:
